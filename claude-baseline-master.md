# Impress Cleaning Services — Project Baseline

> Immutable baseline document.  
> This file defines the complete project scope, architecture, rules, and decisions.  
> All changes after 2025-12-16 are recorded in `patch-log.md`.

---

## Status
- **Baseline established:** 2025-12-16
- **Modification policy:** Append-only via patches
- **Source of truth:** This file + patch log

---

## How to Use This Document
- Do not edit this file directly
- All updates must be added to `patch-log.md`
- Regenerate derived “current state” files as needed

---

## 1. Project Overview

### What the App Does
Impress Cleaning Services is a full-stack web application for managing a residential and commercial cleaning business. It provides:
- **Customer Portal**: Service booking, appointment management, invoice payments, and account management
- **Admin Dashboard**: Customer management, service request handling, appointment scheduling, invoicing, and business analytics
- **Public Website**: Service information, booking requests, gift certificate purchases, privacy policy, and terms of service

### Tech Stack

**Frontend:**
- Next.js 14 (App Router)
- React 18
- Tailwind CSS
- Lucide React (icons)
- Framer Motion (animations)
- React Hot Toast (notifications)
- Canvas Confetti (payment success celebrations)

**Backend:**
- Next.js API Routes (serverless)
- Supabase (PostgreSQL database + Auth + Row Level Security)

**Third-Party Services:**
- **Stripe**: Payment processing, invoicing, saved payment methods
- **Resend**: Transactional emails
- **Cloudflare Turnstile**: CAPTCHA protection
- **Google Places API**: Address autocomplete
- **Google OAuth**: Sign in with Google

### Folder Structure Overview
```
impress-cleaning-site/
├── src/
│   ├── app/
│   │   ├── (public)/         # Public marketing pages
│   │   │   ├── privacy/      # Privacy Policy
│   │   │   └── terms/        # Terms of Service
│   │   ├── admin/            # Admin dashboard pages
│   │   ├── api/              # API routes
│   │   │   ├── admin/        # Admin-only endpoints
│   │   │   ├── customer-portal/  # Customer endpoints
│   │   │   ├── email/        # Email sending endpoints
│   │   │   ├── stripe/       # Stripe payment endpoints
│   │   │   └── webhooks/     # Stripe webhook handler
│   │   ├── auth/             # Authentication pages
│   │   └── portal/           # Customer portal pages
│   ├── components/
│   │   ├── admin/            # Admin-specific components
│   │   ├── portal/           # Portal-specific components
│   │   └── ui/               # Reusable UI components
│   └── lib/
│       ├── supabase/         # Supabase clients
│       ├── emailTemplate.js  # Shared email template utilities (NEW)
│       └── sanitize.js       # Input sanitization
├── public/                   # Static assets
└── CLAUDE.md                 # Project context file
```

---

## 2. Database Schema

### Tables and Columns

#### profiles (Core User Profile)
| Column | Type | Description |
|--------|------|-------------|
| id | UUID (PK) | FK to auth.users |
| email | TEXT (UNIQUE) | User email (synced from auth.users via trigger) |
| full_name | TEXT | Customer/admin name |
| phone | TEXT | Contact phone |
| role | ENUM | 'customer' or 'admin' |
| account_status | ENUM | 'pending', 'active', 'suspended', **'deleted'** |
| communication_preference | ENUM | 'text', 'email', 'both' |
| avatar_url | TEXT | Profile picture URL |
| stripe_customer_id | TEXT | Linked Stripe customer ID |
| **deleted_at** | TIMESTAMPTZ | **NEW** - Soft delete timestamp |
| created_at | TIMESTAMP | Creation timestamp |
| updated_at | TIMESTAMP | Last update timestamp |

#### appointments (Service Appointments)
| Column | Type | Description |
|--------|------|-------------|
| id | UUID (PK) | Appointment ID |
| customer_id | UUID (FK) | References profiles.id |
| address_id | UUID (FK) | References service_addresses.id |
| service_type | ENUM | standard, deep, move_in_out, post_construction, office |
| scheduled_date | DATE | Service date |
| scheduled_time_start | TIME | Start time |
| scheduled_time_end | TIME | End time |
| status | ENUM | pending, confirmed, completed, cancelled, not_completed, en_route |
| team_members | TEXT[] | Array of team member names |
| special_instructions | TEXT | Customer notes |
| is_recurring | BOOLEAN | Recurring flag |
| recurring_frequency | TEXT | weekly, biweekly, monthly |
| parent_recurring_id | UUID (FK) | Self-reference for recurring series |
| **is_running_late** | BOOLEAN | **NEW** - Running behind flag |
| completed_at | TIMESTAMP | Completion timestamp |
| cancelled_at | TIMESTAMP | Cancellation timestamp |
| cancellation_reason | TEXT | Reason for cancellation |

#### service_addresses (Customer Service Locations)
| Column | Type | Description |
|--------|------|-------------|
| id | UUID (PK) | Address ID |
| user_id | UUID (FK) | References profiles.id |
| street_address | TEXT | Street address |
| unit | TEXT | Apartment/unit number |
| city | TEXT | City |
| state | TEXT | State |
| zip_code | TEXT | ZIP code |
| place_id | TEXT | Google Maps place ID |
| is_primary | BOOLEAN | Default service address |

#### invoices (Customer Invoices)
| Column | Type | Description |
|--------|------|-------------|
| id | UUID (PK) | Invoice ID |
| invoice_number | TEXT (UNIQUE) | Format: IMP-XXXXXXX |
| customer_id | UUID (FK) | References profiles.id (nullable) |
| appointment_id | UUID (FK) | References appointments.id (nullable) |
| amount | NUMERIC(10,2) | Base amount |
| total | NUMERIC | Total with tax |
| tax_rate | NUMERIC | Tax percentage |
| tax_amount | NUMERIC(10,2) | Tax amount |
| status | ENUM | draft, sent, paid, overdue, cancelled |
| due_date | DATE | Payment due date |
| paid_date | DATE | Payment received date |
| payment_method | ENUM | stripe, zelle, cash, check |
| stripe_payment_intent_id | TEXT | Stripe payment intent ID |
| stripe_invoice_id | TEXT (UNIQUE) | Stripe invoice ID |
| customer_email | TEXT | Email for orphan invoices |
| line_items | JSONB | Array of {description, rate, quantity} |
| notes | TEXT | Invoice notes |
| refund_amount | NUMERIC(10,2) | Refund amount |
| refund_reason | TEXT | Reason for refund |
| disputed | BOOLEAN | Dispute flag |
| archived | BOOLEAN | Archive flag |

#### service_requests (Customer Service Requests)
| Column | Type | Description |
|--------|------|-------------|
| id | UUID (PK) | Request ID |
| customer_id | UUID (FK) | References profiles.id |
| service_type | ENUM | Type requested |
| preferred_date | DATE | Requested service date |
| preferred_time | TEXT | Requested time bucket |
| is_flexible | BOOLEAN | Flexible on timing |
| address_id | UUID (FK) | References service_addresses.id |
| special_requests | TEXT | Customer notes |
| is_recurring | BOOLEAN | Recurring service flag |
| recurring_frequency | TEXT | weekly, biweekly, monthly |
| status | ENUM | pending, approved, declined, completed |
| admin_notes | TEXT | Admin review notes |
| reviewed_by | UUID (FK) | References profiles.id (admin) |
| reviewed_at | TIMESTAMP | Review timestamp |

#### service_history (Completed Service Records)
| Column | Type | Description |
|--------|------|-------------|
| id | UUID (PK) | History ID |
| appointment_id | UUID (FK) | References appointments.id |
| customer_id | UUID (FK) | References profiles.id |
| service_type | ENUM | Type of service completed |
| completed_date | DATE | Completion date |
| team_members | TEXT[] | Team members who performed service |
| photos | TEXT[] | URLs of service photos |
| notes | TEXT | Service notes |
| customer_rating | INTEGER | 1-5 star rating |
| customer_feedback | TEXT | Customer feedback |

#### payment_methods (Saved Payment Methods)
| Column | Type | Description |
|--------|------|-------------|
| id | UUID (PK) | Payment method ID |
| user_id | UUID (FK) | References profiles.id |
| stripe_payment_method_id | TEXT (UNIQUE) | Stripe payment method ID |
| card_brand | TEXT | Visa, Mastercard, etc. |
| card_last4 | TEXT | Last 4 digits |
| card_exp_month | INTEGER | Expiration month |
| card_exp_year | INTEGER | Expiration year |
| is_default | BOOLEAN | Default payment method |

#### customer_credits (Account Credits/Refunds)
| Column | Type | Description |
|--------|------|-------------|
| id | UUID (PK) | Credit ID |
| customer_id | UUID (FK) | References profiles.id |
| amount | NUMERIC(10,2) | Credit amount |
| description | TEXT | Reason for credit |
| invoice_id | UUID (FK) | Related invoice (nullable) |
| created_by | UUID (FK) | Admin who created (nullable) |

#### customer_notifications (Customer In-App Notifications)
| Column | Type | Description |
|--------|------|-------------|
| id | UUID (PK) | Notification ID |
| user_id | UUID (FK) | References auth.users |
| type | TEXT | Notification type |
| title | TEXT | Notification title |
| message | TEXT | Notification message |
| link | TEXT | Link to related resource |
| reference_id | UUID | ID of related resource |
| reference_type | TEXT | Type of resource |
| is_read | BOOLEAN | Read status |
| read_at | TIMESTAMP | When read |

#### admin_notifications (Admin System Notifications)
| Column | Type | Description |
|--------|------|-------------|
| id | UUID (PK) | Notification ID |
| type | TEXT | Notification type |
| title | TEXT | Notification title |
| message | TEXT | Notification message |
| link | TEXT | Link to related resource |
| is_read | BOOLEAN | Read status |

#### admin_settings (Configuration - Singleton)
| Column | Type | Description |
|--------|------|-------------|
| id | INTEGER (PK) | Always 1 |
| business_name | TEXT | Business name |
| business_email | TEXT | Business email |
| business_phone | TEXT | Phone number |
| price_standard | INTEGER | Standard cleaning price |
| price_deep | INTEGER | Deep cleaning price |
| price_move_in_out | INTEGER | Move in/out price |
| price_post_construction | INTEGER | Post-construction price |
| price_office | INTEGER | Office cleaning price |
| business_hours | JSONB | Hours by day |

#### booking_requests (Public Booking Inquiries)
| Column | Type | Description |
|--------|------|-------------|
| id | UUID (PK) | Booking ID |
| name | TEXT | Customer name |
| email | TEXT | Customer email |
| phone | TEXT | Customer phone |
| address | TEXT | Service address |
| service_type | TEXT | Requested service type |
| preferred_date | TEXT | Preferred date |
| status | TEXT | pending, processed, etc. |

#### customer_reviews (Service Reviews)
| Column | Type | Description |
|--------|------|-------------|
| id | UUID (PK) | Review ID |
| customer_id | UUID (FK) | References auth.users |
| rating | INTEGER | 1-5 star rating |
| review_text | TEXT | Review content |

### Relationships
- **profiles** 1:N appointments, service_addresses, service_requests, invoices, payment_methods
- **appointments** N:1 profiles, N:1 service_addresses, 1:N service_history
- **invoices** N:1 profiles (nullable), N:1 appointments (nullable)
- **service_requests** N:1 profiles, N:1 service_addresses

### Row Level Security Policies
- **Customers**: Can view/update only their own data
- **Admins**: Full access to all data (role = 'admin' check via `is_admin()` function)
- **Service Role**: Internal operations bypass RLS

---

## 3. Authentication Flow

### How Users Sign Up
**File:** `src/app/auth/signup/page.jsx`

1. User enters email, password (8+ chars), completes CAPTCHA
2. `supabase.auth.signUp()` creates auth user
3. Database trigger `handle_new_user()` creates profile with role='customer'
4. User redirected to `/auth/verify-email`
5. User clicks email verification link
6. Redirects to `/auth/callback` which exchanges code for session
7. If profile incomplete, redirects to `/auth/profile-setup`

### How Users Log In
**File:** `src/app/auth/login/page.jsx`

**Methods:**
- Email/password login
- Google OAuth (Sign in with Google)

1. User enters email, password, completes CAPTCHA (or clicks Google)
2. `supabase.auth.signInWithPassword()` authenticates
3. Checks email verification status
4. Fetches user profile to check role and completeness
5. If admin → `/admin/dashboard`
6. If customer → `/portal/dashboard`

### How Sessions are Managed
**Files:** `src/lib/supabase/middleware.js`, `src/lib/supabase/server.js`

- Next.js middleware runs on every request
- `updateSession()` refreshes tokens automatically
- HTTP-only secure cookies managed by Supabase SSR
- Protected routes (`/portal/*`, `/admin/*`) require authentication

### Role-Based Access
- **Roles**: `customer` (default), `admin`
- **Middleware**: Checks auth for `/portal/*` and `/admin/*`
- **Admin check**: Fetches profile, verifies `role === 'admin'`
- **RLS**: Database policies enforce access at query level

### Admin Login Security
- **Email**: `portal@impressyoucleaning.com` (private alias)
- **Password Change**: Available in Admin Settings → Account tab

---

## 4. All API Routes

### Admin Routes (`/api/admin/`)

| Route | Method | Description |
|-------|--------|-------------|
| `/admin/approve-service-request` | POST | Approves request, creates appointment, sends confirmation email |
| `/admin/decline-service-request` | POST | Declines request with reason, sends decline email |
| `/admin/create-appointment` | POST | Admin creates appointment directly with email + notification |
| `/admin/create-invoice` | POST | Creates draft invoice with line items |
| `/admin/update-invoice` | POST | Updates existing invoice |
| `/admin/invoices/send` | POST | Finalizes invoice in Stripe, sends to customer |
| `/admin/invoices/mark-paid` | POST | Marks invoice paid (for Zelle/cash/check) |
| `/admin/invoices/cancel` | POST | Cancels invoice, voids in Stripe if applicable |
| `/admin/invoices/apply-credit` | POST | Applies customer credit to invoice |
| `/admin/update-appointment` | POST | Updates appointment, sends reschedule email if date changed |
| `/admin/delete-appointment` | POST | Deletes appointment |
| `/admin/get-all-customers` | GET | Returns all customer profiles with addresses |
| `/admin/get-all-appointments` | GET | Returns all appointments with customer/address data |
| `/admin/get-all-invoices` | GET | Returns all invoices with customer data |
| `/admin/get-service-requests` | GET | Returns all service requests |
| `/admin/customers/create` | POST | Admin creates customer account |

### Customer Portal Routes (`/api/customer-portal/`)

| Route | Method | Description |
|-------|--------|-------------|
| `/customer-portal/service-requests` | POST | Submits new service request |
| `/customer-portal/invoice/[id]` | GET | Get invoice details |
| `/customer-portal/delete-account` | POST | **Soft delete** customer account |

### Stripe Routes (`/api/stripe/`)

| Route | Method | Description |
|-------|--------|-------------|
| `/stripe/create-payment-intent` | POST | Creates payment intent for portal invoice |
| `/stripe/pay-stripe-invoice` | POST | Pays Stripe Dashboard invoice |
| `/stripe/create-setup-intent` | POST | Creates setup intent for saving cards |
| `/stripe/save-payment-method` | POST | Saves payment method to customer |

### Email Routes (`/api/email/`)

| Route | Method | Description |
|-------|--------|-------------|
| `/email/appointment-confirmed` | POST | Sends appointment confirmation |
| `/email/appointment-cancelled` | POST | Sends cancellation notice |
| `/email/appointment-rescheduled` | POST | Sends reschedule notice |
| `/email/notify-appointment-change` | POST | Notifies admin of customer reschedule/cancel request |
| `/email/service-request-declined` | POST | Notifies customer of declined request |
| ~~`/email/service-request-received`~~ | ~~POST~~ | **DELETED** - Portal notification sufficient |

### Webhook Routes (`/api/webhooks/`)

| Route | Method | Description |
|-------|--------|-------------|
| `/webhooks/stripe` | POST | Handles all Stripe webhook events |

### Other Routes

| Route | Method | Description |
|-------|--------|-------------|
| `/booking` | POST | Public booking form submission |
| `/create-gift-checkout` | POST | Creates Stripe checkout for gift certificates |
| `/send-gift-certificate` | POST | Sends gift certificate email |
| `/notifications/zelle-alert` | POST | Alerts admin of Zelle payment claim |
| `/verify-recaptcha` | POST | Verifies Cloudflare Turnstile |
| `/cron/process-overdue` | POST | Cron job for overdue invoice processing |

---

## 5. Frontend Pages

### Public Pages (`src/app/(public)/`)

| Page | Description |
|------|-------------|
| `/` | Landing page with services overview |
| `/residential-section` | Residential services detail |
| `/commercial` | Commercial cleaning services |
| `/about-us` | Company information |
| `/faq` | Frequently asked questions |
| `/cleaning-tips` | Cleaning tips blog |
| `/booking` | Public booking request form |
| `/service-quote` | Service quote request |
| `/gift-certificate` | Gift certificate purchase |
| `/apply` | Job applications |
| `/aplicar` | Spanish job applications |
| `/privacy` | Privacy Policy |
| `/terms` | Terms of Service |

### Auth Pages (`src/app/auth/`)

| Page | Description |
|------|-------------|
| `/auth/login` | Login with email/password or Google |
| `/auth/signup` | Create new account |
| `/auth/verify-email` | Email verification notice |
| `/auth/profile-setup` | Complete profile after signup |
| `/auth/forgot-password` | Request password reset |
| `/auth/reset-password` | Set new password |
| `/auth/callback` | OAuth/email verification handler |

### Customer Portal Pages (`src/app/portal/`)

| Page | Description |
|------|-------------|
| `/portal/dashboard` | Customer dashboard with overview + **Arriving Today** badge |
| `/portal/request-service` | Submit new service request |
| `/portal/appointments` | List all appointments (with reschedule/cancel) |
| `/portal/invoices` | List all invoices + **Cancellation Policy modal** |
| `/portal/invoices/[id]/pay` | Pay specific invoice |
| `/portal/settings` | Profile, password, email, **payment methods** |
| `/portal/service-history` | Past service history |
| `/portal/customer-feedback` | Leave feedback |
| `/portal/notifications` | View notifications |

### Admin Pages (`src/app/admin/`)

| Page | Description |
|------|-------------|
| `/admin/dashboard` | Admin dashboard with stats and insights |
| `/admin/requests` | View/manage service requests |
| `/admin/customers` | Customer list and management (CRM) |
| `/admin/appointments` | Appointment management + **Running Behind toggle** |
| `/admin/invoices` | Invoice management with edit/resend features |
| `/admin/reports` | Business reports/analytics |
| `/admin/notifications` | Admin notifications page |
| `/admin/settings` | Business settings + Account tab with password change |

---

## 6. Detailed User Flows

### Flow A: New Customer Signup
1. User visits `/auth/signup`
2. Enters email, password (8+ chars), completes CAPTCHA
3. `supabase.auth.signUp()` creates auth user
4. Trigger creates profile with role='customer', status='pending'
5. User redirected to `/auth/verify-email`
6. User clicks verification link in email
7. Redirected to `/auth/callback` → `/auth/profile-setup`
8. User completes profile (name, phone)
9. Profile status updated to 'active'
10. Redirected to `/portal/dashboard`

### Flow B: Customer Submits Service Request
1. Customer visits `/portal/request-service`
2. Selects service type, date, time preference
3. Selects or adds service address
4. Adds special requests (optional)
5. Submits request
6. API creates service_request with status='pending'
7. Customer notification created
8. Admin notification created
9. Customer sees confirmation

### Flow C: Admin Approves Service Request
1. Admin visits `/admin/requests`
2. Views pending request details
3. Clicks "Approve"
4. Selects date, time window, team members
5. API creates appointment with status='confirmed'
6. Updates service_request status='approved'
7. Sends confirmation email to customer
8. Creates customer notification
9. Customer sees appointment in portal

### Flow D: Admin Declines Service Request
1. Admin visits `/admin/requests`
2. Views pending request
3. Clicks "Decline"
4. Enters decline reason
5. API updates service_request status='declined'
6. Sends decline email to customer (uses standardized template)
7. Creates customer notification

### Flow E: Admin Creates Appointment Directly
1. Admin visits `/admin/appointments`
2. Clicks "Create Appointment"
3. Selects customer from dropdown
4. Customer addresses load automatically
5. Selects address, service type, date, time window
6. Adds special instructions (optional)
7. API creates appointment with status='confirmed'
8. Sends confirmation email
9. Creates customer notification

### Flow F: Admin Reschedules Appointment
1. Admin visits `/admin/appointments`
2. Clicks on appointment
3. Changes date/time
4. Saves changes
5. API updates appointment
6. Sends reschedule email to customer (uses standardized template)
7. Creates customer notification

### Flow G: Customer Reschedules Appointment
1. Customer visits `/portal/appointments`
2. Clicks "Reschedule" on appointment
3. If within 48 hours, button disabled with tooltip showing policy
4. Selects new preferred date/time
5. API sets appointment status='pending'
6. Sends confirmation email to customer
7. Sends notification to admin
8. Admin reviews and approves/modifies

### Flow H: Customer Cancels Appointment
1. Customer visits `/portal/appointments`
2. Clicks "Cancel" on appointment
3. Confirms cancellation
4. API updates status='cancelled'
5. Sends cancellation email to customer
6. Notifies admin

### Flow I: Admin Creates Invoice
1. Admin visits `/admin/invoices`
2. Clicks "Create Invoice"
3. Selects customer or creates new
4. Adds line items (description, rate, quantity)
5. Sets tax rate (8.25%, None, Custom)
6. Adds notes (optional)
7. Saves as draft
8. Reviews and clicks "Send"
9. API creates Stripe invoice, sends to customer
10. Creates customer notification

### Flow J: Admin Edits Draft Invoice
1. Admin visits `/admin/invoices`
2. Finds draft invoice
3. Clicks "Edit"
4. Modifies line items, tax, notes
5. Saves changes
6. Can then send when ready

### Flow K: Admin Resends Invoice
1. Admin visits `/admin/invoices`
2. Finds sent/overdue invoice
3. Clicks "Resend"
4. API resends email via Stripe
5. Customer receives new email

### Flow L: Customer Pays Invoice
1. Customer visits `/portal/invoices`
2. Clicks "Pay Now" on unpaid invoice
3. Redirected to `/portal/invoices/[id]/pay`
4. Enters card or uses saved payment method
5. Clicks "Pay"
6. Stripe processes payment
7. Webhook updates invoice status='paid'
8. Success animation plays
9. Customer notification created

### Flow M: Admin Cancels/Refunds Invoice
1. Admin visits `/admin/invoices`
2. Clicks on invoice
3. Clicks "Cancel" or "Refund"
4. Confirms action
5. API voids in Stripe if applicable
6. Updates invoice status
7. Creates customer credit if refund

### Flow N: Admin Changes Password
1. Admin visits `/admin/settings`
2. Clicks "Account" tab
3. Enters new password (min 8 characters)
4. Confirms new password
5. Clicks "Update Password"
6. `supabase.auth.updateUser({ password: newPassword })` called
7. Toast success, fields cleared

### Flow O: Customer Portal Invite
1. Admin creates invoice with customer email (no account needed)
2. Admin invites customer via Supabase Dashboard
3. Customer receives branded invite email
4. Customer clicks link, sets password
5. `link_orphan_invoices` trigger runs
6. Customer logs in, invoice already linked

### Flow P: Customer Deletes Account (NEW)
1. Customer visits `/portal/settings`
2. Clicks "Delete Account"
3. Confirms deletion
4. API soft deletes:
   - Sets `account_status = 'deleted'`
   - Sets `deleted_at` timestamp
   - Anonymizes email to `deleted_[id]@removed.local`
   - Clears phone
   - Anonymizes addresses
   - Deletes payment methods
   - Deletes auth.users record
5. Confirmation email sent to original email
6. Customer logged out

### Flow Q: Arriving Today & Running Behind (NEW)
1. Customer appointment scheduled for today
2. Customer visits `/portal/dashboard`
3. Sees "Arriving Today" badge automatically
4. If admin enables "Running Behind":
   - Admin clicks toggle in `/admin/appointments`
   - Sets `is_running_late = true`
   - Creates customer notification
5. Customer sees "Running slightly behind" message
6. Admin can toggle off when back on schedule

---

## 7. Email System

### Email Templates (Standardized in v6.0)
**File:** `src/lib/emailTemplate.js`

**Shared Utilities:**
```javascript
// Main template wrapper
generateEmailTemplate(title, content)

// Appointment details table
generateAppointmentDetailsHtml(appointment)

// Colored info boxes
generateInfoBox(message, type) // type: 'info' | 'warning' | 'success'

// Service type labels
serviceLabelMap = {
  standard: 'Standard Cleaning',
  deep: 'Deep Cleaning',
  move_in_out: 'Move In/Out Cleaning',
  post_construction: 'Post-Construction Cleaning',
  office: 'Office Cleaning'
}

// Time formatting (12-hour)
formatTime(time)

// Date formatting (locale)
formatDate(date)
```

### Email Triggers Summary

| Trigger | Email Type | Recipient | Template |
|---------|-----------|-----------|----------|
| Customer signup | Admin notification | Admin | Direct |
| Admin approves request | Appointment confirmed | Customer | **Standardized** |
| Admin declines request | Request declined | Customer | **Standardized** |
| Admin creates appointment | Appointment confirmed | Customer | **Standardized** |
| Admin reschedules | Appointment rescheduled | Customer | **Standardized** |
| Customer requests reschedule | Pending notice | Customer + Admin | Direct |
| Customer cancels | Cancellation confirmed | Customer + Admin | **Standardized** |
| Gift certificate purchased | Gift certificate | Recipient | Direct |
| Invoice sent/resent | Invoice notification | Customer | Stripe |
| Portal invite | Invite email | Customer | Supabase |
| Account deleted | Confirmation | Customer | Direct |

### Email Addresses
- **From**: `notifications@impressyoucleaning.com`
- **From (gifts)**: `gifts@impressyoucleaning.com`
- **Admin**: `admin@impressyoucleaning.com`
- **Admin Login**: `portal@impressyoucleaning.com` (private)
- **SMS Gateway**: `5129989658@tmomail.net`

### Logo URL
```
https://bzcdasbrdaonxpomzakh.supabase.co/storage/v1/object/public/public-assets/logo_impress_white.png
```

---

## 8. Payment System (Stripe Integration)

### Payment Methods
- **Credit/Debit Cards** via Stripe
- **Zelle** (manual verification)
- **Cash** (admin marks paid)
- **Check** (admin marks paid)

### Invoice Flow
1. Admin creates invoice with line items
2. Tax calculated (8.25% default for Texas)
3. Invoice saved as draft
4. Admin sends → Stripe invoice created
5. Customer receives email with payment link
6. Customer pays via portal or Stripe link
7. Webhook updates status to 'paid'

### Saved Payment Methods
- Customers can save cards via Setup Intent
- Default card used for quick payments
- Single card auto-shows as default
- Stripe Link disabled (`disableLink: true`)

### Refunds & Credits
- Admin can issue partial/full refunds
- Refunds processed through Stripe
- Customer credits tracked in `customer_credits` table

---

## 9. Components Library

### UI Components (`src/components/ui/`)

| Component | Props | Description |
|-----------|-------|-------------|
| `Button` | variant, size, fullWidth, loading, disabled, onClick | Primary action button |
| `Card` | className, padding, hover | Container card with shadow |
| `Modal` | isOpen, onClose, title, maxWidth, **centered**, children | **Portal-based** dialog |
| `Input` | label, error, icon, type, placeholder, fullWidth | Form input |
| `PasswordInput` | label, error, showToggle | Password with show/hide |
| `Badge` | variant, size, children | Status/count badge |
| `LoadingSpinner` | size | Loading spinner |
| `SkeletonLoader` | type | Skeleton loading placeholder |
| `Toast` | - | Toast notifications |
| `TurnstileWidget` | onVerify, onError | Cloudflare CAPTCHA |
| `AddressAutocomplete` | onSelect | Google Places autocomplete |
| `SelectableCard` | selected, onClick | Selectable card |

### Button Variants
- `primary`: Green background (#079447)
- `secondary`: Navy border, outline style
- `ghost`: Text only, subtle hover
- `danger`: Red background
- `success`: Green for confirmations
- `warning`: Yellow/amber
- `outline`: Border only

### Modal Component (Updated v6.0)
```jsx
// Standard modal
<Modal isOpen={open} onClose={close} title="Title" maxWidth="md">
  {children}
</Modal>

// Centered modal (new)
<Modal isOpen={open} onClose={close} title="Title" maxWidth="sm" centered>
  {children}
</Modal>
```

### Admin Components (`src/components/admin/`)

| Component | Description |
|-----------|-------------|
| `AdminNav` | Sidebar navigation with routes and pending counts |
| `AdminNotificationBell` | Notification dropdown (uses useMemo) |

### Portal Components (`src/components/portal/`)

| Component | Description |
|-----------|-------------|
| `PortalNav` | Customer portal sidebar navigation |
| `RecentNotificationsCard` | Dashboard notifications card (uses useMemo) |
| `SupportCard` | Support contact card |
| `InvoiceSidePanel` | Invoice details slide-out panel |

---

## 10. Environment Variables
```bash
# Supabase
NEXT_PUBLIC_SUPABASE_URL=
NEXT_PUBLIC_SUPABASE_ANON_KEY=
SUPABASE_SERVICE_ROLE_KEY=

# Stripe
STRIPE_SECRET_KEY=
NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY=
STRIPE_WEBHOOK_SECRET=

# Resend (Email)
RESEND_API_KEY=

# Cloudflare Turnstile (CAPTCHA)
NEXT_PUBLIC_TURNSTILE_SITE_KEY=
TURNSTILE_SECRET_KEY=

# Google Places API
NEXT_PUBLIC_GOOGLE_MAPS_API_KEY=

# App URLs
NEXT_PUBLIC_SITE_URL=
NEXT_PUBLIC_APP_URL=
```

---

## 11. Known Patterns

### Modal Usage Pattern (Updated v6.0)
```jsx
// Uses React Portal - escapes parent overflow constraints
<Modal isOpen={open} onClose={() => setOpen(false)} title="Title" maxWidth="md">
  {children}
</Modal>

// Centered variant for policies
<Modal isOpen={open} onClose={() => setOpen(false)} title="Policy" maxWidth="sm" centered>
  {children}
</Modal>
```

### Date Handling Pattern (Timezone-Safe)
```javascript
// WRONG - causes timezone shift
new Date(scheduled_date)

// CORRECT - treats as local date
new Date(scheduled_date + 'T00:00:00')

// For display
format(new Date(apt.scheduled_date + 'T00:00:00'), 'EEE, MMM d, yyyy')
```

### Realtime Subscription Pattern (Prevents Leaks)
```jsx
import { useState, useEffect, useMemo } from 'react'
import { createClient } from '@/lib/supabase/client'

export default function Component() {
  // CRITICAL: Use useMemo to prevent recreation on every render
  const supabase = useMemo(() => createClient(), [])
  
  useEffect(() => {
    const channel = supabase
      .channel('my-channel')
      .on('postgres_changes', { ... }, callback)
      .subscribe()
    
    // CRITICAL: Cleanup on unmount
    return () => supabase.removeChannel(channel)
  }, []) // Empty deps - runs once
}
```

### Input Sanitization Pattern
```javascript
import { sanitizeText } from '@/lib/sanitize'

// Before using in filter
const q = sanitizeText(searchQuery)?.toLowerCase() || ''

// Before saving to database
notes: newInvoice.notes ? sanitizeText(newInvoice.notes.trim()) : null,
```

### Error Handling Pattern (No Debug Logs)
```javascript
try {
  const supabase = await createClient()
  const { data: { user } } = await supabase.auth.getUser()

  if (!user) {
    return NextResponse.json({ error: 'Unauthorized' }, { status: 401 })
  }

  const { data, error } = await supabase.from('table').select()
  if (error) throw error

  return NextResponse.json({ success: true, data })
} catch (error) {
  return NextResponse.json({ error: error.message }, { status: 500 })
}
```

### Loading State Pattern (Skeleton)
```jsx
const [loading, setLoading] = useState(true)

if (loading) {
  return (
    <div className="space-y-4">
      {[...Array(4)].map((_, i) => (
        <SkeletonLoader key={i} type="card" />
      ))}
    </div>
  )
}
```

### Role-Based Route Protection
```javascript
const { data: profile } = await supabase
  .from('profiles')
  .select('role')
  .eq('id', user.id)
  .single()

if (profile?.role !== 'admin') {
  return NextResponse.json({ error: 'Forbidden' }, { status: 403 })
}
```

### Notification Creation Pattern
```javascript
// Customer notification
await supabaseAdmin.from('customer_notifications').insert({
  user_id: customerId,
  type: 'appointment_confirmed',
  title: 'Appointment Scheduled',
  message: `Your ${serviceType} has been scheduled for ${date}`,
  link: '/portal/appointments',
  reference_id: appointmentId,
  reference_type: 'appointment'
})

// Admin notification
await supabaseAdmin.from('admin_notifications').insert({
  type: 'new_service_request',
  title: 'New Request',
  message: `${customerName} submitted a service request`,
  link: '/admin/requests',
  is_read: false
})
```

---

## Quick Reference

### Key Database Functions
- `generate_invoice_number()`: Creates IMP-XXXXXXX format
- `handle_new_user()`: Trigger creating profile on signup
- `link_orphan_invoices()`: Links email-only invoices to new users
- `is_admin()`: Helper checking admin role
- `sync_user_email()`: Syncs auth.users.email to profiles.email on change

### Service Types
- `standard`: Standard Cleaning
- `deep`: Deep Cleaning
- `move_in_out`: Move In/Out Cleaning
- `post_construction`: Post-Construction Cleaning
- `office`: Office Cleaning

### Time Slots (Admin Create Appointment)
- `morning`: 8:00 AM - 12:00 PM
- `afternoon`: 12:00 PM - 3:00 PM
- `evening`: 3:00 PM - 5:45 PM

### Invoice Statuses
`draft` → `sent` → `paid` | `overdue` | `cancelled`

### Appointment Statuses
`pending` → `confirmed` → `en_route` → `completed` | `cancelled` | `not_completed`

### Account Statuses
`pending` → `active` | `suspended` | `deleted`

### Status Labels (Customer Portal)
- `pending`: "Pending Approval"
- `confirmed`: "Confirmed"
- `en_route`: "En Route"
- `completed`: "Completed"
- `cancelled`: "Cancelled"
- `not_completed`: "Not Completed"

---

