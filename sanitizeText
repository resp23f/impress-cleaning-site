# Security Fixes Implementation Guide

## âœ… Fix 1: Google Places Debouncing

**What it does:** Reduces API calls to Google Places (saves you money!)

**File:** `src/components/ui/AddressAutocomplete.jsx`

**Action:** Replace your current file with `AddressAutocomplete-updated.jsx`

**Changes made:**
- Added 300ms debounce on input changes
- Added XSS sanitization for all address fields
- Added proper cleanup of Google Maps listeners
- Added `autoComplete="off"` to prevent browser autocomplete conflicts

**Cost savings:** ~60% reduction in API calls (only triggers after user stops typing)

---

## âœ… Fix 2: XSS Protection

**What it does:** Prevents malicious code injection through user inputs

**File:** `src/lib/sanitize.js` (NEW FILE - create this)

**Action:** Create the file, then use it everywhere you display user data

---

## ğŸ¯ Where to Use XSS Sanitization

### **Critical places (do these first):**

#### 1. Profile Setup Page (`/src/app/auth/profile-setup/page.jsx`)

**Before submitting to database:**
```javascript
import { sanitizeText, sanitizePhone } from '@/lib/sanitize'

const handleSubmit = async (e) => {
  // ...
  const { error: profileError } = await supabase
    .from('profiles')
    .update({
      full_name: sanitizeText(formData.fullName),  // â† ADD
      phone: sanitizePhone(formData.phone),         // â† ADD
      // ...
    })
}
```

#### 2. Invoice Notes (`/src/app/admin/invoices/page.jsx`)

**When creating invoices:**
```javascript
import { sanitizeText } from '@/lib/sanitize'

const handleCreateInvoice = async () => {
  // ...
  const { error } = await supabase
    .from('invoices')
    .insert({
      // ...
      notes: sanitizeText(newInvoice.notes),  // â† ADD
    })
}
```

#### 3. Service Requests (`/src/app/portal/request-service/page.jsx`)

**When submitting special requests:**
```javascript
import { sanitizeText } from '@/lib/sanitize'

const handleSubmit = async () => {
  // ...
  const { error } = await supabase
    .from('service_requests')
    .insert({
      // ...
      special_requests: sanitizeText(formData.specialRequests),  // â† ADD
    })
}
```

#### 4. Settings Page (`/src/app/portal/settings/page.jsx`)

**When updating profile:**
```javascript
import { sanitizeText, sanitizePhone, sanitizeEmail } from '@/lib/sanitize'

const handleUpdateProfile = async () => {
  // ...
  const { error } = await supabase
    .from('profiles')
    .update({
      full_name: sanitizeText(profileData.full_name),    // â† ADD
      phone: sanitizePhone(profileData.phone),           // â† ADD
      email: sanitizeEmail(profileData.email),           // â† ADD
    })
}
```

---

## ğŸ” Quick Audit Checklist

Run through your app and check these:

### **âœ… Forms that submit to database:**
- [ ] Profile setup form
- [ ] Service request form
- [ ] Invoice creation form
- [ ] Settings update form
- [ ] Address forms

### **âœ… Text displayed from database:**
- [ ] Customer names on invoices
- [ ] Service notes
- [ ] Invoice notes
- [ ] Customer addresses
- [ ] Special requests

### **âœ… Admin panels:**
- [ ] Customer list
- [ ] Invoice list
- [ ] Service requests list
- [ ] Appointment notes

---

## ğŸš¨ What NOT to Sanitize

**Don't sanitize:**
- Passwords (hashed by Supabase)
- Dates (use native date pickers)
- Stripe tokens (handled by Stripe)
- UUIDs (generated by database)
- Enums/selects (predefined options)

---

## ğŸ¯ Priority Implementation

**Do these NOW (before launch):**

1. âœ… Replace AddressAutocomplete (5 min)
2. âœ… Create sanitize.js utility (copy/paste - 1 min)
3. âœ… Add to profile-setup form (2 min)
4. âœ… Add to service request form (2 min)

**Total time: 10 minutes**

**Do these POST-LAUNCH:**
- Add to admin invoice creation
- Add to settings page
- Audit all other forms

---

## ğŸ“ Example Usage

```javascript
import { sanitizeText, sanitizePhone, sanitizeEmail } from '@/lib/sanitize'

// Before saving to database
const cleanName = sanitizeText(userInput.name)
const cleanPhone = sanitizePhone(userInput.phone)
const cleanEmail = sanitizeEmail(userInput.email)

// When displaying (for extra safety)
<p>{sanitizeText(customer.notes)}</p>
```

---

## âœ… Testing

After implementing, test with these malicious inputs:

1. **Name field:** `<script>alert('xss')</script>John`
   - Should show: `John` (script tags removed)

2. **Notes field:** `onclick=alert('xss')`
   - Should remove the onclick handler

3. **Address:** `123 Main<iframe>St`
   - Should show: `123 MainSt` (iframe removed)

If any of these execute code, the sanitization isn't working!

---

## ğŸ‰ You're Protected!

Once these are in place:
- âœ… Reduced Google API costs
- âœ… Protected from XSS attacks
- âœ… Clean user data in database
- âœ… Safe to display any user content

**Launch with confidence!** ğŸš€